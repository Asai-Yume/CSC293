# Wireguard setup for accessing the printer

I've set up a IPv6 Wireguard tunnel to access the printer. You'll need to
[install Wireguard](https://www.wireguard.com/install/) on your machine.

## Generate an IPv6 address

Use the [ulagen.py](../scripts/ulagen.py) script to generate an IPv6
address for your device:

```
python3 ./ulagen.py fd29:2be2:cb1e::/64
```

Note: `ulagen.py` generates random IPv6 addresses every time it is run.

## Configure Wireguard

```
[Interface]

# pre-populated by the WireGuard UI
PrivateKey = ...

# the IP address of this client on the WireGuard network
Address = [IPv6 address generated by ulagen.py]

# for MacOS Ventura?
# MTU = 1384

[Peer]
PublicKey=ilvnJHUy/edrGhjN5nVCyJ7bTAaaMAdC/SBrf8p06x0=
Endpoint=wg.thirdlaw.net:55820
AllowedIPs=fd29:2be2:cb1e::/64
```

## Send Your Information

Send the following information:

  - IPv6 address
  - PUBLIC key

to me (Prof. Pai).

## Testing

Activate the Wireguard tunnel.

You should be able to ping the following addresses:

```
# ping6 trident.thirdlaw.net # on mac
ping trident.thirdlaw.net
```
If it does not ping, check with me if I can see ping packets coming in. If I can detect traffic, but there are no replies to your pings, check that you have sent me the correct IP and the correct public key.

Try downloading:

```
curl http://trident.thirdlaw.net/
```

This should show some HTML. If it does not, your Wireguard connection
is still not working, see the troubleshooting section below.

You can now switch to accessing the URL in the browser, make sure it
is using HTTP and not HTTPS, otherwise you will get a site unreachable
error. Some browsers based on Chrome will not allow you to use
HTTP. In such cases, use the raw IP below and bookmark the address:

```
http://[fd29:2be2:cb1e::1]/
```

## Troubleshooting

### Check Wireguard has created a tunnel

The `/sbin/ifconfig` command on both Linux and Mac should show you if you have an interface with the IPv6 address you generated. The output formatting will be different for Linux and Mac. Below is an example from a Linux machine.

```
/sbin/ifconfig

wg0: flags=209<UP,POINTOPOINT,RUNNING,NOARP>  mtu 1420
        inet6 fd29:2be2:cb1e::X  prefixlen 64  scopeid 0x0<global>

```

If you don't have such an interface (and its name could be different), you should check if you have activated the Wireguard tunnel.


### Check the MTU

If no traffic is detected between your machine and the Wireguard
server, it could be an MTU issue.

On some systems (MacOS Ventura?), the default MTU appears to be too
large for the server. If the MTU shown by `/sbin/ifconfig` is greater
than 1500, set the MTU in your Wireguard configuration (shown above)
and restart the tunnel.

### Check the route

If pings are still failing, make sure the route is correct.

```
route get -inet6 trident.thirdlaw.net # only on MacOS
```

### Check the IP and Key settings

Make sure you've sent me the correct IP and the correct _public_ key.

### Other

Send me an email.

